<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario PMC</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/estilos.css') }}">



</head>
{% include "base.html" %}


<body>
  

<script>
function ajustarFilasPorPagina() {
  const altoVentana = window.innerHeight;
  const altoHeader = document.querySelector('header').offsetHeight;
  const altoTitulo = document.querySelector('.titulo-principal').offsetHeight;
  const altoAcciones = document.querySelector('.acciones-superiores').offsetHeight;
  const altoFila = 30;  // altura aproximada de cada fila en píxeles

  const alturaDisponible = altoVentana - altoHeader - altoTitulo - altoAcciones - 100; // margen extra
  let filas = Math.floor(alturaDisponible / altoFila);
  filas = Math.max(5, Math.min(filas, 16)); // mínimo 5, máximo 16 filas

  const url = new URL(window.location.href);
  const actualPorPagina = url.searchParams.get('por_pagina');

  if (actualPorPagina != filas.toString()) {
    url.searchParams.set('por_pagina', filas);
    url.searchParams.set('page', 1);
    window.location.href = url.toString();
  }
}

window.addEventListener('load', ajustarFilasPorPagina);
// window.addEventListener('resize', ajustarFilasPorPagina); /* opcional */
</script>



<h1 class="titulo-principal">ICU Medical - Product for PMC Inventory</h1>

<div class="container">
  <div class="acciones-superiores">
    <input type="text" id="buscador" placeholder="Buscar en la tabla..." value="{{ busqueda }}">
    

    <div class="botones-acciones">
      <button class="boton-agregar" onclick="window.location.href='/agregar'">Agregar Producto</button>
      <button class="boton-exportar" onclick="exportarExcel()">Exportar a Excel</button>
    </div>
  </div>

  <!-- NUEVO: contenedor con scroll y altura limitada -->
  <div class="tabla-scroll-container">
    <table id="tabla-inventario">
      <thead>
        <tr>
          <th>LOT</th>
          <th>List Number</th>
          <th>Description</th>
          <th>Product Type</th>
          <th>Located</th>
          <th>Date-In</th>
          <th>Qty Vol.</th>
          <th>Unit</th>
         <!--  <th>Income</th>-->
         <!--  <th>Spent</th> -->
          <th class="stock">STOCK</th>
          <th>Qty Per Box</th>
          <th>Box Available</th>
          <th>Max Storage (Days)</th>
          <th>Due Date</th>
          <th>Days Available</th>
          <th>Status</th>
          <th>Note</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for producto in productos %}
        <tr>
          <td>{{ producto.LOT | default('--')}}</td>
          <td>{{ producto.ListNumber| default('--') }}</td>
          <td>{{ producto.Description| default('--') }}</td>
          <td>{{ producto.Product_Type| default('--') }}</td>
          <td>{{ producto.Located| default('--') }}</td>
          <td>{{ producto.Date_In| default('--') }}</td>
          <td>{{ producto.QTY_Vol| default('--') }}</td>
          <td>{{ producto.Unit| default('--') }}</td>
         <!--  <td>{{ producto.Income if producto.Income is defined else '' }}</td>-->
           <!-- <td>{{ producto.Spent if producto.Spent is defined else '' }}</td> -->
          <td class="stock {% if producto.STOCK|int <= 0 %}agotado{% endif %}">
            {% if producto.STOCK|int <= 0 %}
              Agotado
            {% else %}
              {{ producto.STOCK }}
            {% endif %}
          </td>
          <td>{{ producto.Qty_Per_Box| default('--') }}</td>
          <td>{{ producto.Box_Available| default('--') }}</td>
          <td>{{ producto.Maximum_Storage_Days| default('--') }}</td>
          <td>{{ producto.Due_Date| default('--') }}</td>
          <td>{{ producto.Days_Available| default('--') }}</td>
          <td>{{ producto.Status| default('--') }}</td>
          <td>{{ producto.Note | default('--')}}</td>
          <td class="acciones-btn">
  <a href="{{ url_for('editar', id=producto._id) }}" class="btn-editar">Editar</a>
  <button class="btn-eliminar" onclick="confirmarEliminacion('{{ producto._id }}')">Eliminar</button>

</td>

        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="paginacion" style="margin-top: 10px; text-align: center;">
      {% if total_paginas > 1 %}
        <nav aria-label="Page navigation">
          <ul style="list-style: none; display: inline-flex; padding: 0; gap: 5px;">
            <li>
              {% if page > 1 %}
                <a href="{{ url_for('inventario', page=page-1, por_pagina=por_pagina, q=busqueda) }}" style="padding: 5px 10px; border: 1px solid #0072c6; color: #0072c6; text-decoration: none; border-radius: 5px;">Anterior</a>
              {% else %}
                <span style="padding: 5px 10px; border: 1px solid #ccc; color: #ccc; border-radius: 5px; cursor: not-allowed;">Anterior</span>
              {% endif %}
            </li>

            {% for p in range(1, total_paginas + 1) %}
              {% if p == page %}
                <li><span style="padding: 5px 10px; background-color: #0072c6; color: white; border-radius: 5px;">{{ p }}</span></li>
              {% elif p >= page - 2 and p <= page + 2 %}
                <li><a href="{{ url_for('inventario', page=p, por_pagina=por_pagina, q=busqueda) }}" style="padding: 5px 10px; border: 1px solid #0072c6; color: #0072c6; text-decoration: none; border-radius: 5px;">{{ p }}</a></li>
              {% elif p == 1 or p == total_paginas %}
                <li><a href="{{ url_for('inventario', page=p, por_pagina=por_pagina, q=busqueda) }}" style="padding: 5px 10px; border: 1px solid #0072c6; color: #0072c6; text-decoration: none; border-radius: 5px;">{{ p }}</a></li>
              {% elif p == page - 3 or p == page + 3 %}
                <li><span style="padding: 5px 10px;">...</span></li>
              {% endif %}
            {% endfor %}

            <li>
              {% if page < total_paginas %}
                <a href="{{ url_for('inventario', page=page+1, por_pagina=por_pagina, q=busqueda) }}" style="padding: 5px 10px; border: 1px solid #0072c6; color: #0072c6; text-decoration: none; border-radius: 5px;">Siguiente</a>
              {% else %}
                <span style="padding: 5px 10px; border: 1px solid #ccc; color: #ccc; border-radius: 5px; cursor: not-allowed;">Siguiente</span>
              {% endif %}
            </li>
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>

</div>

<script>
  // Búsqueda dinámica
// Búsqueda dinámica con debounce para no perder el cursor

document.getElementById('buscador').addEventListener('input', function () {
  const query = this.value.trim();

  // Si el input está vacío, enviar q vacío para traer todo
  fetch(`/inventario?q=${encodeURIComponent(query)}`)
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // Actualiza el tbody con los nuevos datos
      const nuevoTbody = doc.querySelector('#tabla-inventario tbody');
      const tbodyActual = document.querySelector('#tabla-inventario tbody');
      if (nuevoTbody && tbodyActual) {
        tbodyActual.innerHTML = nuevoTbody.innerHTML;
      }

      // Actualiza la paginación
      const nuevaPaginacion = doc.querySelector('.paginacion');
      const paginacionActual = document.querySelector('.paginacion');
      if (nuevaPaginacion && paginacionActual) {
        paginacionActual.innerHTML = nuevaPaginacion.innerHTML;
      }
    })
    .catch(err => console.error('Error en la búsqueda:', err));
});




  // Exportar a Excel con SheetJS
  function exportarExcel() {
    const table = document.getElementById('tabla-inventario');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Inventario"});
    XLSX.writeFile(wb, 'inventario_pmc.xlsx');
  }
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  function confirmarEliminacion(id) {
    if (confirm("¿Estás seguro de que quieres eliminar este producto?")) {
      fetch(`/eliminar/${id}`, {
        method: 'POST'
      }).then(response => {
        if (response.redirected) {
          window.location.href = response.url; // redirige al inventario
        } else {
          alert('Error al eliminar');
        }
      }).catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar');
      });
    }
  }
</script>



</body>
</html>
